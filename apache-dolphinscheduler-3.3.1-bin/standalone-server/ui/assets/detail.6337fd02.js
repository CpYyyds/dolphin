import{l as C}from"./lodash.3a74b132.js";import{u as w,E as L,r as b,d as J,G as B,H as S,o as V,I as O,c as _,i as q}from"./index.02a17cf1.js";import{a as A,b as x}from"./index.e05b7da6.js";import{t as z,v as $,u as k,c as G}from"./index.22550073.js";import{M as H}from"./index.08dd828f.js";import{F as W,g as K}from"./get-elements-by-json.9f02e085.js";import{N as Q}from"./Input.59461546.js";import{N as X}from"./Select.51d2f90f.js";import{N as Y}from"./Button.1b3ea9f7.js";import"./service.ade35c11.js";import"./ui-setting.7e6814b1.js";import"./index.fe057c74.js";import"./Modal.920fa101.js";import"./keysOf.843c523b.js";import"./Card.f8db533a.js";import"./resolve-slot.92499a18.js";import"./index.5f9a33e7.js";import"./index.8a81335d.js";import"./flatten.8ad131a2.js";import"./Scrollbar.988383de.js";import"./VResizeObserver.f80d6e55.js";import"./use-false-until-truthy.e57d8f60.js";import"./fade-in-scale-up.cssr.d8408fe5.js";import"./utils.eff12f29.js";import"./is-browser.e7afaa57.js";import"./index.21198e00.js";import"./Space.8a344b95.js";import"./get-slot.eeb09d52.js";import"./Form.de76c832.js";import"./FormItem.aeb1ee46.js";import"./use-form-item.96cfc8ba.js";import"./format-length.a6a40b1f.js";import"./get.852d0cd9.js";import"./Grid.1918be0a.js";import"./next-frame-once.50ecadf2.js";import"./Spin.4db05d4b.js";import"./use-compitable.cd47f4ac.js";import"./Radio.4578e023.js";import"./RadioGroup.7b709552.js";import"./use-merged-state.2bdc3563.js";import"./index.7b2dcdb8.js";import"./DeleteOutlined.d3b97bbb.js";import"./Switch.a01ace9e.js";import"./InputNumber.cad532d0.js";import"./use-locale.47aab0f5.js";import"./Add.a9b5dac9.js";import"./Checkbox.c8f5c3b1.js";import"./Empty.249462a1.js";import"./cssr.f561ccf0.js";import"./Popover.92dc7b00.js";import"./_baseMap.d8d47059.js";import"./Suffix.62982c61.js";function Z(){const{t:s}=w(),m={instanceName:"",pluginDefineId:null},e=L({detailFormRef:b(),detailForm:{...m},uiPlugins:[],pluginsLoading:!1,json:[]}),r={model:e.detailForm,requireMarkPlacement:"left",labelPlacement:"left",labelWidth:180,rules:{instanceName:{trigger:"input",required:!0,message:s("security.alarm_instance.alarm_instance_name_tips")},pluginDefineId:{trigger:["blur","change"],required:!0,validator(l,i){if(!i&&i!==0)return new Error(s("security.alarm_instance.select_plugin_tips"))}}}},g=async()=>{if(!e.pluginsLoading){e.pluginsLoading=!0;try{const l=await x({pluginType:"ALERT"});e.uiPlugins=l.map(i=>({label:i.pluginName,value:i.id})),e.pluginsLoading=!1}catch{e.pluginsLoading=!1}}};return{meta:r,state:e,setDetail:l=>{e.detailForm.instanceName=l.instanceName,e.detailForm.pluginDefineId=l.pluginDefineId,l.pluginInstanceParams&&(e.json=JSON.parse(l.pluginInstanceParams)),e.json.forEach(i=>{i.validate&&i.validate.length&&i.validate.find(h=>h.type==="number")&&(i.value=+i.value)})},initForm:()=>{g()},resetForm:()=>{e.detailFormRef.resetValues({...m}),e.json=[]},getFormValues:()=>e.detailForm,changePlugin:async l=>{if(e.pluginsLoading)return;e.pluginsLoading=!0,e.detailForm.pluginDefineId=l;const{pluginParams:i}=await A(l);i&&(e.json=JSON.parse(i)),e.pluginsLoading=!1}}}function R(s){const{t:m}=w(),e=L({saving:!1,testing:!1,loading:!1}),r=(t,a={})=>(t==null||t.forEach(n=>{const u=C.exports.isFunction(n)?n():n;u.value=a[u.field]}),JSON.stringify(t));return{status:e,createOrUpdate:async(t,a)=>{const n=s();if(e.saving)return!1;e.saving=!0;try{return(t==null?void 0:t.instanceName)!==n.instanceName&&await $({alertInstanceName:n.instanceName}),t!=null&&t.id?await k({alertPluginInstanceId:n.pluginDefineId,instanceName:n.instanceName,pluginInstanceParams:r(a,n)},t.id):await G({instanceName:n.instanceName,pluginDefineId:n.pluginDefineId,pluginInstanceParams:r(a,n)}),e.saving=!1,!0}catch{return e.saving=!1,!1}},testSend:async t=>{const a=s();if(!e.testing){e.testing=!0;try{const n=await z({pluginDefineId:a.pluginDefineId,pluginInstanceParams:r(t,a)});window.$message.success(n&&n.msg?n.msg:`${m("security.alarm_instance.test_send")} ${m("home.success")}`)}finally{e.testing=!1}}}}}function ee(s){return typeof s=="function"||Object.prototype.toString.call(s)==="[object Object]"&&!q(s)}const te={show:{type:Boolean,default:!1},currentRecord:{type:Object,default:{}}},et=J({name:"DetailModal",props:te,emits:["cancel","update"],setup(s,m){var D;const{t:e,locale:r}=w(),g=b({}),d=b([]),{meta:t,state:a,setDetail:n,initForm:u,resetForm:l,getFormValues:i,changePlugin:N}=Z(),{status:h,createOrUpdate:v,testSend:F}=R(i),c=()=>{l(),g.value={},d.value=[],m.emit("cancel")},p=async()=>{await a.detailFormRef.validate(),await v(s.currentRecord,a.json)&&(c(),m.emit("update"))},j=async()=>{await a.detailFormRef.validate(),F(a.json)},M=N,U=(D=B())==null?void 0:D.appContext.config.globalProperties.trim;function E(f){try{const o=JSON.parse(f);return typeof o=="object"&&o!==null}catch{return!1}}function T(f){const{props:o}=f;if(!o||!o.placeholder)return;const I=o.placeholder;if(!E(I))return;const y=JSON.parse(I);r.value==="zh_CN"?o.placeholder=y.zhMsg:r.value==="en_US"&&(o.placeholder=y.enMsg)}return S(()=>s.show,async()=>{s.show&&s.currentRecord&&n(s.currentRecord)}),S(()=>a.json,()=>{var I;if(!((I=a.json)!=null&&I.length))return;a.json.forEach(y=>{const P=C.exports.isFunction(y)?y():y;P.name=e("security.alarm_instance."+P.field),T(P)});const{rules:f,elements:o}=K(a.json,a.detailForm);g.value=f,d.value=o}),V(()=>{u()}),{t:e,...O(a),...O(h),meta:t,rules:g,elements:d,onChangePlugin:M,onSubmit:p,onTest:j,onCancel:c,trim:U}},render(s){const{show:m,t:e,meta:r,rules:g,elements:d,detailForm:t,uiPlugins:a,pluginsLoading:n,loading:u,saving:l,onChangePlugin:i,onCancel:N,onSubmit:h,onTest:v,testing:F}=this,{currentRecord:c}=s;return _(H,{show:m,title:e(c!=null&&c.id?"security.alarm_instance.edit_alarm_instance":"security.alarm_instance.create_alarm_instance"),onConfirm:h,confirmLoading:l||u,onCancel:N},{default:()=>_(W,{ref:"detailFormRef",loading:u||n,meta:{...r,rules:{...r.rules,...g},elements:[{path:"instanceName",label:e("security.alarm_instance.alarm_instance_name"),widget:_(Q,{allowInput:this.trim,value:t.instanceName,"onUpdate:value":p=>t.instanceName=p,placeholder:e("security.alarm_instance.alarm_instance_name_tips")},null)},{path:"pluginDefineId",label:e("security.alarm_instance.select_plugin"),widget:_(X,{value:t.pluginDefineId,"onUpdate:value":p=>t.pluginDefineId=p,options:a,disabled:!!(c!=null&&c.id),placeholder:e("security.alarm_instance.select_plugin_tips"),"on-update:value":i,filterable:!0},null)},...d]},layout:{cols:24}},null),"btn-middle":()=>{let p;return _(Y,{class:"btn-test-send",type:"primary",size:"small",onClick:v,loading:F||u},ee(p=e("security.alarm_instance.test_send"))?p:{default:()=>[p]})}})}});export{et as default};
