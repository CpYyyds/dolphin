import{u as k,E as g,r as w,bH as L,bI as I}from"./index.02a17cf1.js";import{l as v,_ as D}from"./lodash.3a74b132.js";import{i as G,f as P,a as b}from"./index.9cbc470c.js";import{q as N}from"./index.e3e49908.js";import{l as R}from"./index.124d1fef.js";import{s as M}from"./index.bcd2e05d.js";import{s as u}from"./service.ade35c11.js";import{p as j}from"./common.a16f92ec.js";import{q as O}from"./index.0bedecf2.js";import{q as _}from"./index.7552dd4e.js";import{k as c}from"./index.8474b6bf.js";const ne=()=>{const{t:e}=k(),o=new Date,i=o.getFullYear(),s=o.getMonth(),d=o.getDate(),n=g({importFormRef:w(),importForm:{name:"",file:""},saving:!1,importRules:{file:{required:!0,trigger:["input","blur"],validator(){if(n.importForm.name==="")return new Error(e("project.workflow.enter_name_tips"))}}}}),m=g({startFormRef:w(),startForm:{workflowDefinitionCode:-1,startEndTime:[new Date(i,s,d),new Date(i,s,d)],scheduleTime:"",dataDateType:1,failureStrategy:"CONTINUE",warningType:"NONE",warningGroupId:null,execType:"START_PROCESS",startNodeList:"",taskDependType:"TASK_POST",complementDependentMode:"OFF_MODE",runMode:"RUN_MODE_SERIAL",workflowInstancePriority:"MEDIUM",workerGroup:"default",tenantCode:"default",environmentCode:null,startParams:null,expectedParallelismNumber:"2",dryRun:0,version:null,allLevelDependent:"false",executionOrder:"DESC_ORDER"},saving:!1,rules:{scheduleTime:{trigger:["input","blur"],validator(F,p){if(!p)return;if(!/(((19|20)[0-9]{2})-((0[1-9])|(1[0-2]))-((0[1-9])|((1|2)[0-9])|(3[0-1]))([ ])([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9]))(,(((19|20)[0-9]{2})-((0[1-9])|(1[0-2]))-((0[1-9])|((1|2)[0-9])|(3[0-1]))([ ])([0-1]?[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])))*$/.test(p))return new Error(e("project.workflow.schedule_date_tips"));if(p.split(",").length>100)return new Error(e("project.workflow.schedule_date_limit"))}},warningGroupId:{trigger:["blur"],validator(){if(m.startForm.warningType!=="NONE"&&!m.startForm.warningGroupId)return new Error(e("project.workflow.warning_group_tip"))}}}}),l=g({timingFormRef:w(),timingForm:{startEndTime:[new Date(i,s,d),new Date(i+100,s,d)],crontab:"0 0 * * * ? *",timezoneId:Intl.DateTimeFormat().resolvedOptions().timeZone,failureStrategy:"CONTINUE",warningType:"NONE",workflowInstancePriority:"MEDIUM",warningGroupId:null,workerGroup:"default",tenantCode:"default",environmentCode:null},saving:!1,rules:{warningGroupId:{trigger:["blur"],validator(){if(l.timingForm.warningType!=="NONE"&&!l.timingForm.warningGroupId)return new Error(e("project.workflow.warning_group_tip"))}}}}),f=g({copyFormRef:w(),copyForm:{projectCode:null},saving:!1,copyRules:{projectCode:{required:!0,trigger:["input","blur"],validator(){if(f.copyForm.projectCode==="")return new Error(e("project.workflow.project_name_required"))}}}});return{importState:n,startState:m,timingState:l,copyState:f}};function ie(e,o){return u({url:`/projects/${o}/schedules`,method:"get",params:e})}function $(e,o){return u({url:`/projects/${o}/schedules`,method:"post",data:e})}function H(e,o){return u({url:`/projects/${o}/schedules/preview`,method:"post",data:e})}function q(e,o,i){return u({url:`/projects/${o}/schedules/${i}`,method:"put",data:e})}function ae(e,o){return u({url:`/projects/${o}/schedules/${e}`,method:"delete",params:{scheduleId:e}})}function se(e,o){return u({url:`/projects/${e}/schedules/${o}/offline`,method:"post"})}function me(e,o){return u({url:`/projects/${e}/schedules/${o}/online`,method:"post"})}function ue(e,o){const{t:i}=k(),s=L(),d=I(),n=g({projectCode:Number(d.params.projectCode),workerGroups:[],tenantList:[],alertGroups:[],environmentList:[],startParamsList:[],schedulePreviewList:[]}),m={},l=()=>{e.importForm.name="",e.importForm.file=""},f=async()=>{if(await e.importFormRef.validate(),!e.saving){e.saving=!0;try{const t=new FormData;t.append("file",e.importForm.file);const r=Number(s.currentRoute.value.params.projectCode);await G(t,r),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show"),l()}catch{e.saving=!1}}},F=async(t,r)=>{if(await e.startFormRef.validate(),!e.saving){e.saving=!0;try{e.startForm.workflowDefinitionCode=t,e.startForm.version=r;const a=v.exports.omit(e.startForm,["startEndTime","scheduleTime","dataDateType"]);if(e.startForm.dataDateType===1){const y=c(new Date(e.startForm.startEndTime[0]),"yyyy-MM-dd HH:mm:ss"),h=c(new Date(e.startForm.startEndTime[1]),"yyyy-MM-dd HH:mm:ss");a.scheduleTime=JSON.stringify({complementStartDate:y,complementEndDate:h})}else a.scheduleTime=JSON.stringify({complementScheduleDateList:e.startForm.scheduleTime});a.startParams=D.isEmpty(n.startParamsList)?"":JSON.stringify(n.startParamsList),await M(a,n.projectCode),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show")}catch{e.saving=!1}}},p=async t=>{if(await e.timingFormRef.validate(),!e.saving){e.saving=!0;try{const r=C();r.workflowDefinitionCode=t,await $(r,n.projectCode),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show")}catch{e.saving=!1}}},T=async t=>{if(await e.timingFormRef.validate(),!e.saving){e.saving=!0;try{const r=C();r.id=t,await q(r,n.projectCode,t),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show")}catch{e.saving=!1}}},E=async t=>{if(await e.copyFormRef.validate(),!e.saving){e.saving=!0;try{const r={codes:D.join(t,","),targetProjectCode:e.copyForm.projectCode};await P(r,n.projectCode),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show"),e.copyForm.projectCode=""}catch{e.saving=!1}}},C=()=>{const t=c(j(e.timingForm.startEndTime[0]),"yyyy-MM-dd HH:mm:ss"),r=c(j(e.timingForm.startEndTime[1]),"yyyy-MM-dd HH:mm:ss");return{schedule:JSON.stringify({startTime:t,endTime:r,crontab:e.timingForm.crontab,timezoneId:e.timingForm.timezoneId}),failureStrategy:e.timingForm.failureStrategy,warningType:e.timingForm.warningType,workflowInstancePriority:e.timingForm.workflowInstancePriority,warningGroupId:e.timingForm.warningGroupId?e.timingForm.warningGroupId:0,workerGroup:e.timingForm.workerGroup,tenantCode:e.timingForm.tenantCode,environmentCode:e.timingForm.environmentCode}};return{variables:n,handleImportDefinition:f,handleStartDefinition:F,handleCreateTiming:p,handleUpdateTiming:T,handleBatchCopyDefinition:E,getWorkerGroups:()=>{_(n.projectCode).then(t=>{n.workerGroups=t.data.map(r=>({label:r.workerGroup,value:r.workerGroup}))})},getTenantList:()=>{O().then(t=>{n.tenantList=t.map(r=>({label:r.tenantCode,value:r.tenantCode}))})},getAlertGroups:()=>{R().then(t=>{n.alertGroups=t.map(r=>({label:r.groupName,value:r.id}))})},getEnvironmentList:()=>{N().then(t=>{n.environmentList=t.map(r=>({label:r.name,value:r.code,workerGroups:r.workerGroups}))})},getStartParamsList:t=>{if(m[t]){n.startParamsList=v.exports.cloneDeep(m[t]);return}b(t,n.projectCode).then(r=>{n.startParamsList=r.workflowDefinition.globalParamList,m[t]=v.exports.cloneDeep(n.startParamsList)})},getPreviewSchedule:()=>{e.timingFormRef.validate(async t=>{if(!t){const r=Number(s.currentRoute.value.params.projectCode),a=c(new Date(e.timingForm.startEndTime[0]),"yyyy-MM-dd HH:mm:ss"),y=c(new Date(e.timingForm.startEndTime[1]),"yyyy-MM-dd HH:mm:ss"),h=JSON.stringify({startTime:a,endTime:y,crontab:e.timingForm.crontab,timezoneId:e.timingForm.timezoneId});H({schedule:h},r).then(S=>{n.schedulePreviewList=S})}})}}}export{ue as a,me as b,ae as d,se as o,ie as q,ne as u};
