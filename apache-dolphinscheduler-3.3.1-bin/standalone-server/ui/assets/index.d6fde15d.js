import{O as J,H as A,bI as W,r as C,o as ae,E as ie,u as se,h as Le,co as De,d as Ne,bu as Se,R as ne,Y as _,g as B,V as ye,c as S}from"./index.02a17cf1.js";import Ee from"./dag-toolbar.91545edf.js";import be from"./dag-canvas.47760e6d.js";import Re from"./dag-sidebar.26619340.js";import{S as K}from"./dag.module.806bc1a0.js";import{u as Me,D as Ie}from"./dag-auto-layout-modal.a03ef1a7.js";import"./index.7d2218cd.js";import{l as x}from"./lodash.3a74b132.js";import{u as xe}from"./index.9b0cc109.js";import{g as Ve,C as Ae}from"./dag-context-menu.4080e7eb.js";import{T as $,u as Oe}from"./task-type.618fb0da.js";import"./gForce.e00398bc.js";import{a as Ue,X as Pe,N as je,i as _e}from"./dag-config.e2eb20b1.js";import"./service.ade35c11.js";import Be from"./dag-node-status.5341bb4a.js";import{f as $e,N as Xe}from"./detail-modal.d43b66ed.js";import{t as Ye}from"./common.a16f92ec.js";import{a as Fe}from"./index.8587fc8e.js";import He from"./version-modal.8b7bf837.js";import qe from"./dag-save-modal.631fc24b.js";import{S as Ge}from"./start-modal.3068e161.js";import{L as Ke,q as Je}from"./index.61e15cc7.js";/* empty css                 */import{u as We}from"./ui-setting.7e6814b1.js";import{e as ze}from"./index.bcd2e05d.js";import Qe from"./dependencies-modal.425ef74a.js";import"./use-text-copy.5aaa6a47.js";import"./use-message.66b07366.js";import"./dag-startup-param.2e925564.js";import"./index.124d1fef.js";import"./index.e5f69831.js";import"./SettingOutlined.901415e1.js";import"./PauseCircleOutlined.6f50ffc5.js";import"./CloseCircleOutlined.d6e82e31.js";import"./CheckCircleOutlined.b15d9580.js";import"./EditOutlined.8be88705.js";import"./index.8474b6bf.js";import"./variables-view.9c8f6618.js";import"./index.9cbc470c.js";import"./Button.1b3ea9f7.js";import"./is-browser.e7afaa57.js";import"./use-form-item.96cfc8ba.js";import"./resolve-slot.92499a18.js";import"./use-dependencies.c18c5099.js";import"./index.b889db2d.js";import"./CopyOutlined.05f74603.js";import"./SearchOutlined.280f9205.js";import"./DownloadOutlined.bd8b049e.js";import"./SyncOutlined.d69d028f.js";import"./DeleteOutlined.d3b97bbb.js";import"./FullscreenOutlined.f113d9e5.js";import"./InfoCircleOutlined.ab212e51.js";import"./Tooltip.76a430fa.js";import"./Popover.92dc7b00.js";import"./index.8a81335d.js";import"./flatten.8ad131a2.js";import"./Scrollbar.988383de.js";import"./VResizeObserver.f80d6e55.js";import"./use-false-until-truthy.e57d8f60.js";import"./_baseMap.d8d47059.js";import"./get.852d0cd9.js";import"./cssr.f561ccf0.js";import"./utils.eff12f29.js";import"./format-length.a6a40b1f.js";import"./use-merged-state.2bdc3563.js";import"./use-compitable.cd47f4ac.js";import"./next-frame-once.50ecadf2.js";import"./Icon.0cd298dd.js";import"./text.856015a6.js";import"./Select.51d2f90f.js";import"./fade-in-scale-up.cssr.d8408fe5.js";import"./use-locale.47aab0f5.js";import"./Empty.249462a1.js";import"./index.5f9a33e7.js";import"./Suffix.62982c61.js";import"./index.21198e00.js";import"./toNumber.f676da43.js";import"./debounce.aab20534.js";import"./typeof.481ce13f.js";import"./Spin.4db05d4b.js";import"./ChevronRight.d1d16011.js";import"./StarOutlined.bba1a3a2.js";import"./index.08dd828f.js";import"./index.fe057c74.js";import"./Modal.920fa101.js";import"./keysOf.843c523b.js";import"./Card.f8db533a.js";import"./Space.8a344b95.js";import"./get-slot.eeb09d52.js";import"./RadioButton.2774fa7f.js";import"./RadioGroup.7b709552.js";import"./Form.de76c832.js";import"./FormItem.aeb1ee46.js";import"./InputNumber.cad532d0.js";import"./Input.59461546.js";import"./Add.a9b5dac9.js";import"./detail.cc97a982.js";import"./get-elements-by-json.9f02e085.js";import"./Grid.1918be0a.js";import"./Radio.4578e023.js";import"./index.7b2dcdb8.js";import"./Switch.a01ace9e.js";import"./Checkbox.c8f5c3b1.js";import"./index.module.a7688846.js";import"./ArrowUpOutlined.5d908421.js";import"./index.7552dd4e.js";import"./index.e3e49908.js";import"./index.a8939d99.js";import"./index.b0aa157e.js";import"./index.747658f4.js";import"./index.2cf2fa64.js";import"./index.d2c86bbc.js";import"./Ellipsis.eed9f363.js";import"./index.1f780a3d.js";import"./ProfileOutlined.14374bcc.js";import"./use-modal.c59c2056.js";import"./index.0bedecf2.js";import"./Popconfirm.98866df0.js";import"./DataTable.ddc5a79d.js";import"./ArrowDown.fd6213c2.js";import"./Dropdown.de4044d8.js";import"./use-keyboard.8f9f6db8.js";import"./Forward.b8f2636c.js";import"./DynamicInput.728c18a6.js";import"./ButtonGroup.1b8a381d.js";import"./DatePicker.d4b2a484.js";import"./throttle.1d7e3cbb.js";function Ze(){function o(i,T,v){const g={};T.forEach(t=>{const a=t.getTargetCellId();g[a]=!0});const f=t=>!g[t],m={};i.forEach(t=>{const a=t.id,n=v.find(l=>l.code===Number(a));n&&(m[a]=n)});const w=i.filter(t=>f(t.id)).map(t=>{const a=m[t.id];return{name:"",preTaskCode:0,preTaskVersion:0,postTaskCode:a.code,postTaskVersion:a.version||0,conditionType:"NONE",conditionParams:{}}}),h=T.map(t=>{const a=t.getLabels(),n=x.exports.get(a,["0","attrs","label","text"],""),l=t.getSourceCellId(),s=m[l],d=t.getTargetCellId(),k=m[d];return{name:n,preTaskCode:s.code,preTaskVersion:s.version||0,postTaskCode:k.code,postTaskVersion:k.version||0,conditionType:"NONE",conditionParams:{}}});return w.concat(h)}function u(i){return i.map(T=>{const v=+T.id,{x:g,y:f}=T.getPosition();return{taskCode:v,x:g,y:f}})}return{getLocations:u,getConnects:o}}function et(o){const{graph:u}=o,{buildNode:i,buildEdge:T}=re();function v(n,l){var d;const s=(d=u.value)==null?void 0:d.getCellById(n);if(s){const k=J.truncateText(l,18);s.attr("title/text",k),s.setData({taskName:l})}}function g(n,l){var d;const s=(d=u.value)==null?void 0:d.getCellById(n);if(!s)return!1;s.attr("rect/fill",l)}function f(n,l,s,d,k={x:100,y:100}){var R;if(!$[l])return;const N=i(n,l,s,d,k);(R=u.value)==null||R.addNode(N)}function m(n){var l;(l=u.value)==null||l.removeNode(n)}const w=n=>{var d,k;const l=(d=u.value)==null?void 0:d.getCellById(n);return l?((k=u.value)==null?void 0:k.getConnectedEdges(l))||[]:[]};return{setNodeName:v,setNodeFillColor:g,setNodeEdge:(n,l)=>{const s=w(n);s!=null&&s.length&&s.forEach(d=>{var k,N;((k=d.getTargetNode())==null?void 0:k.id)===n&&((N=u.value)==null||N.removeEdge(d))}),l.forEach(d=>{var k;(k=u.value)==null||k.addEdge(T(String(d),n))})},addNode:f,removeNode:m,getSources:n=>{const l=w(n);if(!l.length)return[];const s=[];return l.forEach(d=>{const k=d.getSourceNode();k&&k.id!==n&&s.push(Number(k.id))}),s},getTargets:n=>{const l=w(n);if(!l.length)return[];const s=[];return l.forEach(d=>{const k=d.getTargetNode();k&&k.id!==n&&s.push(Number(k.id))}),s}}}function re(){function o(v){let g=null;return v?(g=JSON.parse(v),Array.isArray(g)?g:null):g}function u(v,g,f="",m=!1){return{shape:Ue,source:{cell:v},target:{cell:g},labels:f?[f]:void 0,attrs:{line:{strokeDasharray:m?"5 5":"none"}}}}function i(v,g,f,m,w={x:100,y:100}){const h=f?J.truncateText(f,18):v;return{id:v,shape:Pe,x:w.x,y:w.y,data:{taskType:g,taskName:f||v,flag:m,taskExecuteType:$[g].taskExecuteType},attrs:{image:{"xlink:href":`/dolphinscheduler/ui/images/task-icons/${(g!=="FLINK_STREAM"?g:"FLINK").toLocaleLowerCase()}.png`},title:{text:h},rect:{fill:m==="NO"?"var(--custom-disable-bg)":"#ffffff"}}}}function T(v){const g=[],f=[],m=o(v.workflowDefinition.locations)||[],w=v.taskDefinitionList,h=v.workflowTaskRelationList,t={};return w.forEach(a=>{const n=m.find(s=>s.taskCode===a.code)||{},l=i(a.code+"",a.taskType,a.name,a.flag,{x:n.x,y:n.y});g.push(l),t[String(a.code)]=a.taskType}),h.filter(a=>!!a.preTaskCode).forEach(a=>{const n=$[t[a.preTaskCode]].taskExecuteType==="STREAM"||$[t[a.postTaskCode]].taskExecuteType==="STREAM",l=u(a.preTaskCode+"",a.postTaskCode+"",a.name,n);f.push(l)}),{nodes:g,edges:f}}return{buildNode:i,buildEdge:u,buildGraph:T}}function tt(o){const{graph:u,definition:i}=o,{buildGraph:T}=re();return A([u,i],()=>{u.value&&i.value&&u.value.fromJSON(T(i.value))}),{}}function ot(o){const{readonly:u,graph:i,appendTask:T}=o,v=W(),g=Number(v.params.projectCode),f=C({x:0,y:0,type:"SHELL"});function m(t,a){if(u.value){t.preventDefault();return}f.value={x:t.offsetX,y:t.offsetY,type:a}}function w(t){if(t.stopPropagation(),t.preventDefault(),!u.value&&f.value&&i.value&&g){const{type:a,x:n,y:l}=f.value,{x:s,y:d}=i.value.clientToLocal(t.clientX,t.clientY);Ve(1,g).then(N=>{const[R]=N;T(R,a,{x:s-n,y:d-l})})}}const h=t=>{t.preventDefault()};return{onDragStart:m,onDrop:w,onDragenter:h,onDragover:h,onDragleave:h}}function nt(o){const{graph:u,definition:i}=o,{addNode:T,removeNode:v,getSources:g,getTargets:f,setNodeName:m,setNodeFillColor:w,setNodeEdge:h}=et({graph:u}),t=C((i==null?void 0:i.value)||{workflowDefinition:{},workflowTaskRelationList:[],taskDefinitionList:[]}),a=C({taskType:"SHELL",code:0,name:""}),n=C(!1);function l(c,e,p){T(c+"",e,"","YES",p),t.value.taskDefinitionList.push({code:c,taskType:e,name:""}),k({code:c,taskType:e,name:""})}function s(c,e,p,L,D,y){T(e+"",L,c,D,y);const Y=t.value.taskDefinitionList.find(H=>H.code===p),F={...x.exports.cloneDeep(Y),code:e,name:c};t.value.taskDefinitionList.push(F)}function d(c,e){t.value.taskDefinitionList=t.value.taskDefinitionList.filter(p=>!c.includes(p.code)),c.forEach(p=>{x.exports.remove(t.value.workflowTaskRelationList,L=>L.postTaskCode===p||L.preTaskCode===p)}),e==null||e.forEach(p=>{if(p.isEdge()){const L=p.getSourceCellId(),D=p.getTargetCellId();x.exports.remove(t.value.workflowTaskRelationList,y=>String(y.postTaskCode)===D&&String(y.preTaskCode)===L)}})}function k(c){a.value=c,n.value=!0}function N(c){const e=t.value.taskDefinitionList.find(p=>p.code===c);e&&(a.value=e),O(g(String(c)),c),V(c),n.value=!0}function R({data:c}){const e=$e(c).taskDefinitionJsonObj;t.value.taskDefinitionList=t.value.taskDefinitionList.map(p=>{var L;if(p.code===((L=a.value)==null?void 0:L.code)){m(p.code+"",e.name);let D="#ffffff";return e.flag==="NO"&&(D="var(--custom-disable-bg)"),w(p.code+"",D),h(String(p.code),c.preTasks),O(c.preTasks,p.code),{...e,version:p.version,code:p.code,taskType:a.value.taskType,id:p.id}}return p}),n.value=!1}function X(){n.value=!1,a.value.name||(v(String(a.value.code)),x.exports.remove(t.value.taskDefinitionList,c=>c.code===a.value.code))}function O(c,e){var p,L;(L=(p=t.value)==null?void 0:p.workflowTaskRelationList)!=null&&L.length&&x.exports.remove(t.value.workflowTaskRelationList,D=>D.postTaskCode===e),c!=null&&c.length&&c.forEach(D=>{var y;(y=t.value)==null||y.workflowTaskRelationList.push({postTaskCode:e,preTaskCode:D,name:"",preTaskVersion:1,postTaskVersion:1,conditionType:"NONE",conditionParams:{}})})}function V(c){f(String(c)).forEach(p=>{var L,D;(L=t.value)!=null&&L.workflowTaskRelationList.find(y=>y.postTaskCode===p&&y.preTaskCode===c)||(D=t.value)==null||D.workflowTaskRelationList.push({postTaskCode:p,preTaskCode:c,name:"",preTaskVersion:1,postTaskVersion:1,conditionType:"NONE",conditionParams:{}})})}return ae(()=>{u.value&&u.value.on("cell:dblclick",({cell:c})=>{const e=Number(c.id);N(e)})}),A(i,()=>{i.value&&(t.value=i.value)}),{currTask:a,taskModalVisible:n,workflowDefinition:t,taskConfirm:R,taskCancel:X,appendTask:l,editTask:N,copyTask:s,removeTasks:d}}function at(o){const{graph:u}=o,i=ie({menuVisible:!1,startModalShow:!1,logTaskId:-1,logTaskType:"",pageX:0,pageY:0,menuCell:{},showModalRef:C(!1),row:{},logRef:"",logLoadingRef:C(!0),skipLineNum:C(0),limit:C(1e3),taskCode:""}),T=()=>{var f;i.menuVisible=!1,(f=u.value)==null||f.unlockScroller()},v=f=>{i.startModalShow=!0,i.taskCode=String(f)},g=(f,m)=>{i.logTaskId=f,i.logTaskType=m,i.showModalRef=!0};return ae(()=>{u.value&&u.value.on("node:contextmenu",({cell:f,x:m,y:w})=>{i.menuCell=f;const h=u.value.localToPage(m,w);i.pageX=h.x,i.pageY=h.y,i.menuVisible=!0,u.value.lockScroller()})}),{nodeVariables:i,menuHide:T,menuStart:v,viewLog:g}}function it(o){const{graph:u}=o,i=W(),T=C([]),{t:v}=se(),g=Oe(),f=(w,h,t)=>{var l,s;const a=Ye(v)[h],n=(l=u.value)==null?void 0:l.getCellById(w);if(n){n.removeMarkup(),n.setMarkup(je.markup.concat(_e));const d=(s=u.value)==null?void 0:s.findViewByCell(n),k=d==null?void 0:d.find("div")[0],N=Le(Be,{t:v,taskInstance:t,stateProps:a});De(N,k)}};return{taskList:T,refreshTaskStatus:()=>{const w=Number(i.params.projectCode),h=Number(i.params.id);Fe(h,w).then(t=>{if(window.$message.success(v("project.workflow.refresh_status_succeeded")),T.value=t.taskList,T.value){const a={};T.value.forEach(n=>{f(n.taskCode,n.state,n),n.taskInstanceDependentResults&&n.taskInstanceDependentResults.forEach(s=>{const d=`${s.projectCode}-${s.workflowDefinitionCode}-${s.taskDefinitionCode}-${s.dateCycle}`;a[d]=s.dependentResult})}),g.updateDependentResult(a)}})}}}const st={instance:{type:Object,default:void 0},definition:{type:Object,default:void 0},readonly:{type:Boolean,default:!1},projectCode:{type:Number,default:0}},bn=Ne({name:"workflow-dag",props:st,emits:["refresh","save"],setup(o,u){const{t:i}=se(),T=W(),v=Se(),f=We().getLogTimer;ne("readonly",_(o,"readonly"));const m=C();ne("graph",m),u.expose(m);const{visible:w,toggle:h,formValue:t,formRef:a,submit:n,cancel:l}=Me({graph:m}),{taskConfirm:s,taskModalVisible:d,currTask:k,taskCancel:N,appendTask:R,editTask:X,copyTask:O,workflowDefinition:V,removeTasks:c}=nt({graph:m,definition:_(o,"definition")}),{nodeVariables:e,menuHide:p,menuStart:L,viewLog:D}=at({graph:m}),y=B(()=>o.definition?T.name==="workflow-definition-detail"&&o.definition.workflowDefinition.releaseState==="ONLINE":!1),Y=B(()=>T.name==="workflow-instance-detail"),F=B(()=>o.instance?o.instance.state==="WAITING_THREAD"||o.instance.state==="SUCCESS"||o.instance.state==="PAUSE"||o.instance.state==="FAILURE"||o.instance.state==="STOP":o.definition?o.definition.workflowDefinition.releaseState==="OFFLINE":!1),H=B(()=>{if(e.menuCell){const r=Number(e.menuCell.id);return Z.value.find(b=>b.taskCode===r)}else return}),z=C();A(()=>d.value,()=>{if(o.instance&&d.value){const r=k.value.code;z.value=Z.value.find(b=>b.taskCode===r)}});const Q=C(),{taskList:Z,refreshTaskStatus:U}=it({graph:m}),{onDragStart:le,onDrop:ue}=ot({graph:m,readonly:_(o,"readonly"),appendTask:R});tt({graph:m,definition:_(o,"definition")});const I=C(!1),de=r=>{typeof r=="boolean"?I.value=r:I.value=!I.value},ce=()=>{u.emit("refresh"),I.value=!1},P=C(!1),q=r=>{typeof r=="boolean"?P.value=r:P.value=!I.value},{getConnects:fe,getLocations:me}=Ze(),pe=r=>{var te,oe;const b=((te=m.value)==null?void 0:te.getEdges())||[],M=((oe=m.value)==null?void 0:oe.getNodes())||[];if(!M.length){window.$message.error(i("project.dag.node_not_created")),q(!1);return}const he=fe(M,b,V.value.taskDefinitionList),Ce=me(M);u.emit("save",{taskDefinitions:V.value.taskDefinitionList,saveForm:r,connects:he,locations:Ce}),q(!1)},ee=(r,b)=>{d.value=!1,D(r,b),j(f)};let G;const j=r=>{const{state:b}=xe(Je({taskInstanceId:e.logTaskId,limit:e.limit,skipLineNum:e.skipLineNum}).then(M=>{e.logRef+=M.message||"",M&&M.message!==""?(e.limit+=1e3,e.skipLineNum+=M.lineNum,j(r)):(e.logLoadingRef=!1,r!==0&&(typeof G=="number"&&clearTimeout(G),G=setTimeout(()=>{e.limit+=1e3,e.skipLineNum+=1e3,j(r)},r*1e3)))}),{});return b},ge=r=>{e.logRef="",e.limit=1e3,e.skipLineNum=0,j(r)},ke=(r,b)=>{ze({workflowInstanceId:Number(T.params.id),startNodeList:r,taskDependType:b},o.projectCode).then(()=>{window.$message.success(i("project.workflow.success")),setTimeout(()=>{window.location.reload()},1e3)})},ve=()=>{J.downloadFile("log/download-log",{taskInstanceId:e.logTaskId})},Te=()=>{e.showModalRef=!1},we=()=>{n(),o.instance&&U()},E=ie({showRef:C(!1),taskLinks:C([]),required:C(!1),tip:C(""),action:()=>{}});return A(()=>o.definition,()=>{o.instance&&(U(),Q.value=setInterval(()=>U(),9e4))}),A(()=>e.showModalRef,()=>{e.showModalRef||(e.row={},e.logRef="",e.logLoadingRef=!0,e.skipLineNum=0,e.limit=1e3)}),ye(()=>clearInterval(Q.value)),()=>S("div",{class:[K.dag,K[`dag-${v.darkTheme?"dark":"light"}`]]},[S(Ee,{layoutToggle:h,instance:o.instance,definition:o.definition,onVersionToggle:de,onSaveModelToggle:q,onRemoveTasks:c,onRefresh:U,dependenciesData:E,"onUpdate:dependenciesData":r=>E=r},null),S("div",{class:K.content},[S(Re,{onDragStart:le},null),S(be,{onDrop:ue},null)]),S(Ie,{visible:w.value,submit:we,cancel:l,formValue:t,formRef:a},null),!!o.definition&&S(He,{isInstance:!!o.instance,row:o.definition.workflowDefinition,"onUpdate:row":r=>o.definition.workflowDefinition=r,show:I.value,"onUpdate:show":r=>I.value=r,onUpdateList:ce},null),S(qe,{show:P.value,"onUpdate:show":r=>P.value=r,onSave:pe,definition:o.definition,instance:o.instance},null),S(Xe,{readonly:o.readonly,show:d.value,projectCode:o.projectCode,workflowInstance:o.instance,taskInstance:z.value,onViewLog:ee,data:k.value,definition:V,onSubmit:s,onCancel:N},null),S(Ae,{startDisplay:y.value,executeTaskDisplay:Y.value,menuDisplay:F.value,taskInstance:H.value,cell:e.menuCell,visible:e.menuVisible,left:e.pageX,top:e.pageY,onHide:p,onStart:L,onEdit:X,onCopyTask:O,onRemoveTasks:c,onViewLog:ee,onExecuteTask:ke,dependenciesData:E,"onUpdate:dependenciesData":r=>E=r},null),S(Qe,{show:E.showRef,"onUpdate:show":r=>E.showRef=r,taskLinks:E.taskLinks,"onUpdate:taskLinks":r=>E.taskLinks=r,required:E.required,content:E.tip,onConfirm:E.action},null),!!o.definition&&S(Ge,{row:o.definition.workflowDefinition,"onUpdate:row":r=>o.definition.workflowDefinition=r,show:e.startModalShow,"onUpdate:show":r=>e.startModalShow=r,taskCode:e.taskCode},null),!!o.instance&&S(Ke,{showModalRef:e.showModalRef,logRef:e.logRef,row:e.row,showDownloadLog:!0,logLoadingRef:e.logLoadingRef,onConfirmModal:Te,onRefreshLogs:ge,onDownloadLogs:ve},null)])}});export{bn as default};
