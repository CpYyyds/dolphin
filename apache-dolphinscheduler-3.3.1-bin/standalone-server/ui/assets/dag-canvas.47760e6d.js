import{S as T}from"./dag.module.806bc1a0.js";import{G as v}from"./index.7d2218cd.js";import{a as y,X as A,N as C,E as S,b as O,c as x,P as M,d as b,e as R,f as I,g as P,h as H}from"./dag-config.e2eb20b1.js";import{l as G,_ as o}from"./lodash.3a74b132.js";import{b as z}from"./index.9b0cc109.js";import{C as F}from"./dag-context-menu.4080e7eb.js";import{r as E,o as k,d as K,U as _,c as L}from"./index.02a17cf1.js";import"./task-type.618fb0da.js";import"./gForce.e00398bc.js";import"./service.ade35c11.js";import"./dag-node-status.5341bb4a.js";import"./toNumber.f676da43.js";import"./_baseMap.d8d47059.js";import"./get.852d0cd9.js";import"./debounce.aab20534.js";import"./common.a16f92ec.js";import"./SettingOutlined.901415e1.js";import"./PauseCircleOutlined.6f50ffc5.js";import"./CloseCircleOutlined.d6e82e31.js";import"./CheckCircleOutlined.b15d9580.js";import"./EditOutlined.8be88705.js";import"./index.8474b6bf.js";import"./use-dependencies.c18c5099.js";import"./index.b889db2d.js";import"./Button.1b3ea9f7.js";import"./is-browser.e7afaa57.js";import"./use-form-item.96cfc8ba.js";import"./resolve-slot.92499a18.js";import"./typeof.481ce13f.js";import"./ui-setting.7e6814b1.js";import"./Icon.0cd298dd.js";import"./format-length.a6a40b1f.js";import"./Spin.4db05d4b.js";import"./Scrollbar.988383de.js";import"./VResizeObserver.f80d6e55.js";import"./use-compitable.cd47f4ac.js";import"./index.5f9a33e7.js";import"./Tooltip.76a430fa.js";import"./Popover.92dc7b00.js";import"./index.8a81335d.js";import"./flatten.8ad131a2.js";import"./use-false-until-truthy.e57d8f60.js";import"./cssr.f561ccf0.js";import"./utils.eff12f29.js";import"./use-merged-state.2bdc3563.js";import"./next-frame-once.50ecadf2.js";function V(N){const{readonly:n,graph:r}=N,p=E(),g=E(),u=E();function m(){return v.registerNodeTool("contextmenu",F,!0),new v({container:p.value,selecting:{enabled:!0,multiple:!0,rubberband:!0,rubberEdge:!0,movable:!0,showNodeSelectionBox:!1},scaling:{min:.2,max:2},mousewheel:{enabled:!0,modifiers:["ctrl","meta"]},scroller:!0,grid:{size:10,visible:!0},snapline:!0,minimap:{enabled:!0,container:g.value,scalable:!0,width:250,height:150},interacting:{edgeLabelMovable:!1,nodeMovable:!n.value,magnetConnectable:!n.value},connecting:{allowMulti:!1,allowBlank:!1,allowLoop:!1,allowEdge:!1,allowNode:!0,allowPort:!1,highlight:!0,createEdge(){var t;return(t=r.value)==null?void 0:t.createEdge({shape:y})},validateConnection(t){var i;const{sourceCell:a,targetCell:s}=t;if(a&&s&&a.isNode()&&s.isNode()){const c=a.getData();if(!c||c.taskType!=="CONDITIONS")return!0;const D=(i=r.value)==null?void 0:i.getConnectedEdges(a);if(!D||D.length<2)return!0;let d=0;return!D.some(f=>(f.getSourceCellId()===a.id&&d++,d>2))}return!0},validateEdge({edge:t}){var i,c;const a=(i=t.getSourceNode())==null?void 0:i.getData(),s=(c=t.getTargetNode())==null?void 0:c.getData();return t==null||t.setAttrs({line:{strokeDasharray:a.taskExecuteType==="STREAM"||s.taskExecuteType==="STREAM"?"5 5":"none"}}),!0}},highlighting:{nodeAvailable:{name:"className",args:{className:"available"}},magnetAvailable:{name:"className",args:{className:"available"}},magnetAdsorbed:{name:"className",args:{className:"adsorbed"}}}})}k(()=>{r.value=m(),r.value.on("edge:connected",({isNew:t,edge:a})=>{if(t){const s=a.getSourceNode();a.setSource(s)}}),r.value.on("node:mouseenter",({node:t})=>{const a=t.getData().taskName,i=t.getMarkup().filter(c=>c.tagName==="foreignObject")[0];t.addTools({name:"button",args:{markup:[{tagName:"text",textContent:a,attrs:{fill:"#868686","font-size":16,"text-anchor":"center"}}],x:0,y:0,offset:{x:0,y:i?-28:-10}}})}),r.value.on("node:mouseleave",({node:t})=>{t.removeTool("button")})});const e=G.exports.debounce(()=>{var t;if(u.value){const a=u.value.offsetWidth,s=u.value.offsetHeight;(t=r.value)==null||t.resize(a,s)}},200);z(u,e);function l(){v.unregisterNode(A),v.unregisterEdge(y),v.registerNode(A,{...C}),v.registerEdge(y,{...S})}return k(()=>{l()}),{graph:r,paper:p,minimap:g,container:u}}function X(N){const{graph:n}=N,r=E(),p=e=>e?e.toLocaleLowerCase()==="em"||e.toLocaleLowerCase()==="body":!1;function g(e){var s;const l=e===r.value,t=(s=n.value)==null?void 0:s.isSelected(e);let a=null;l?a=o.merge(o.cloneDeep(S),O):t?a=o.merge(o.cloneDeep(S),x):a=o.cloneDeep(S),e.setAttrs(a.attrs),e.setLabels([{...o.merge({attrs:o.cloneDeep(a.defaultLabel.attrs)})}])}function u(e){var w;const l=e===r.value,t=(w=n.value)==null?void 0:w.isSelected(e),a=o.cloneDeep(M.groups[b].attrs),s=o.cloneDeep(R.groups[b].attrs),i=o.cloneDeep(I.groups[b].attrs),c=o.merge(o.cloneDeep(C.attrs),P.attrs),D=o.merge(o.cloneDeep(C.attrs),H.attrs);let d=null,f=null,h=null;l||t?(d=`/dolphinscheduler/ui/images/task-icons/${(e.data.taskType!=="FLINK_STREAM"?e.data.taskType:"FLINK").toLocaleLowerCase()}_hover.png`,l?(f=c,h=o.merge(i,a)):(f=D,h=o.merge(i,s))):(d=`/dolphinscheduler/ui/images/task-icons/${(e.data.taskType!=="FLINK_STREAM"?e.data.taskType:"FLINK").toLocaleLowerCase()}.png`,f=C.attrs,h=i),e.setAttrByPath("image/xlink:href",d),e.setAttrs(f),e.setPortProp(b,"attrs",h)}function m(e){e.isEdge()?g(e):e.isNode()&&u(e)}return k(()=>{n.value&&(n.value.on("cell:mouseenter",e=>{const{cell:l,e:t}=e;p(t.target.tagName)||(r.value=l,m(l))}),n.value.on("cell:mouseleave",({cell:e})=>{r.value=void 0,m(e)}),n.value.on("cell:selected",({cell:e})=>{m(e)}),n.value.on("cell:unselected",({cell:e})=>{m(e)}))}),{hoverCell:r}}const Pe=K({name:"workflow-dag-canvas",emits:["drop"],setup(N,n){const r=_("readonly",E(!1)),p=_("graph",E()),{paper:g,minimap:u,container:m}=V({readonly:r,graph:p});X({graph:p});const e=l=>{l.preventDefault()};return()=>L("div",{ref:m,class:[T.canvas,"dag-container"],onDrop:l=>{n.emit("drop",l)},onDragenter:e,onDragover:e,onDragleave:e},[L("div",{ref:g,class:T.paper},null),L("div",{ref:u,class:T.minimap},null)])}});export{Pe as default};
