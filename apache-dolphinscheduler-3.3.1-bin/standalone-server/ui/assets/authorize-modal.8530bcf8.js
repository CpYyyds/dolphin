import{E as I,u as j,r as R,o as D,H as w,d as W,I as q,c as r,i as A}from"./index.02a17cf1.js";import{e as L}from"./index.d2c86bbc.js";import{f as U,h as T}from"./index.2cf2fa64.js";import{a as V,u as M}from"./index.747658f4.js";import{r as B,a as G,b as O,c as x,d as F}from"./index.cd03a49b.js";import{M as E}from"./index.08dd828f.js";import{s as g,N as P}from"./index.module.d033057f.js";import{D as H,C as f,c as K}from"./column-width-config.03ebcd18.js";import{S as $}from"./SearchOutlined.280f9205.js";import{N}from"./Space.8a344b95.js";import{N as d}from"./Button.1b3ea9f7.js";import{N as J}from"./Input.59461546.js";import{N as Q}from"./Icon.0cd298dd.js";import{N as X,a as Y}from"./DataTable.ddc5a79d.js";import"./service.ade35c11.js";import"./ui-setting.7e6814b1.js";import"./lodash.3a74b132.js";import"./index.fe057c74.js";import"./Modal.920fa101.js";import"./keysOf.843c523b.js";import"./Card.f8db533a.js";import"./resolve-slot.92499a18.js";import"./index.5f9a33e7.js";import"./index.8a81335d.js";import"./flatten.8ad131a2.js";import"./Scrollbar.988383de.js";import"./VResizeObserver.f80d6e55.js";import"./use-false-until-truthy.e57d8f60.js";import"./fade-in-scale-up.cssr.d8408fe5.js";import"./utils.eff12f29.js";import"./is-browser.e7afaa57.js";import"./index.21198e00.js";import"./use-locale.47aab0f5.js";import"./Empty.249462a1.js";import"./cssr.f561ccf0.js";import"./next-frame-once.50ecadf2.js";import"./Checkbox.c8f5c3b1.js";import"./use-form-item.96cfc8ba.js";import"./use-merged-state.2bdc3563.js";import"./get-slot.eeb09d52.js";import"./Suffix.62982c61.js";import"./format-length.a6a40b1f.js";import"./ArrowDown.fd6213c2.js";import"./RadioGroup.7b709552.js";import"./Radio.4578e023.js";import"./Popover.92dc7b00.js";import"./_baseMap.d8d47059.js";import"./get.852d0cd9.js";import"./use-compitable.cd47f4ac.js";import"./Dropdown.de4044d8.js";import"./ChevronRight.d1d16011.js";import"./Select.51d2f90f.js";import"./use-keyboard.8f9f6db8.js";import"./Ellipsis.eed9f363.js";import"./Tooltip.76a430fa.js";import"./Forward.b8f2636c.js";function Z(){const e=I({saving:!1,loading:!1,projectIds:"",currentRecord:{},projectWithAuthorizedLevel:[],authorizedProjects:[],unauthorizedProjects:[],authorizedDatasources:[],unauthorizedDatasources:[],authorizedNamespaces:[],unauthorizedNamespaces:[],resourceType:"file",fileResources:[],pagination:{pageSize:5,page:1,totalPage:0},searchVal:"",userId:0}),o=async t=>{if(e.loading)return;e.loading=!0,t&&(e.userId=t);const a=await L({userId:t,searchVal:e.searchVal,pageSize:e.pagination.pageSize,pageNo:e.pagination.page});if(e.loading=!1,!a)throw Error();return e.pagination.totalPage=a.totalPage,e.projectWithAuthorizedLevel=a.totalList,e.projectWithAuthorizedLevel},l=async t=>{e.pagination.page=t,await o(e.userId)},i=async t=>{e.pagination.page=1,e.pagination.pageSize=t,await o(e.userId)},c=async(t,a)=>{await B({userId:t,projectIds:a}),await o(t)},n=async(t,a)=>{await G({userId:t,projectIds:a}),await o(t)},p=async(t,a)=>{await O({userId:t,projectIds:a}),await o(t)},s=async t=>{if(e.loading)return;e.loading=!0;const a=await Promise.all([U({userId:t}),T({userId:t})]);e.loading=!1,e.authorizedDatasources=a[0].map(u=>u.id),e.unauthorizedDatasources=[...a[0],...a[1]].map(u=>({label:u.name,value:u.id}))},h=async t=>{if(e.loading)return;e.loading=!0;const a=await Promise.all([V({userId:t}),M({userId:t})]);e.loading=!1,e.authorizedNamespaces=a[0].map(u=>u.id),e.unauthorizedNamespaces=[...a[0],...a[1]].map(u=>({label:u.namespace,value:u.id}))};return{state:e,onInit:(t,a)=>{t==="authorize_project"&&o(a),t==="authorize_datasource"&&s(a),t==="authorize_namespace"&&h(a)},onSave:async(t,a)=>e.saving?!1:(e.saving=!0,t==="authorize_datasource"&&await x({userId:a,datasourceIds:e.authorizedDatasources.join(",")}),t==="authorize_namespace"&&await F({userId:a,namespaceIds:e.authorizedNamespaces.join(",")}),e.saving=!1,!0),getProjects:o,revokeProjectByIdRequest:c,grantProjectRequest:n,grantProjectWithReadPermRequest:p,requestData:l,handleChangePageSize:i}}const ee=[{label:"project.list.no_permission",value:0},{label:"project.list.read_permission",value:2},{label:"project.list.all_permission",value:7}];function te(){const{t:e}=j(),o=R({columns:[],tableWidth:H}),l=()=>{const i=[{type:"selection",key:"selection",...f.checkbox},{title:e("project.list.project_name"),key:"name",...f.size},{title:e("project.list.authorize_level"),key:"perm",render:c=>ee.filter(n=>n.value==c.perm).map(n=>e(n.label)),...f.index}];o.value={columns:i,tableWidth:K(i)}};return D(()=>{l()}),w(j().locale,()=>{l()}),{columnsRef:o,createColumns:l}}function z(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!A(e)}const ae={show:{type:Boolean,default:!1},userId:{type:Number,default:0},type:{type:String,default:"auth_project"}},it=W({name:"authorize-project-modal",props:ae,emits:["cancel"],setup(e,o){const{t:l}=j(),{state:i,onInit:c,onSave:n,getProjects:p,revokeProjectByIdRequest:s,grantProjectRequest:h,grantProjectWithReadPermRequest:y,requestData:v,handleChangePageSize:t}=Z(),a=()=>{o.emit("cancel")},u=async()=>{await n(e.type,e.userId)&&a()},_=()=>{s(e.userId,i.projectIds)},S=()=>{y(e.userId,i.projectIds)},b=()=>{h(e.userId,i.projectIds)},{columnsRef:C}=te(),k=m=>{i.projectIds=m.join()};return w(()=>e.show,()=>{e.show&&c(e.type,e.userId)}),{t:l,columnsRef:C,rowKey:m=>m.id,...q(i),onCancel:a,onConfirm:u,getProjects:p,handleCheck:k,requestData:v,handleChangePageSize:t,onRevokeProject:_,onGrantReadPerm:S,onGrantAllPerm:b}},render(e){let o,l,i;const{t:c}=this,{type:n,userId:p}=e;return r(E,{show:this.show,title:c(`security.user.${n}`),onCancel:this.onCancel,confirmLoading:this.loading,onConfirm:this.onConfirm,confirmClassName:"btn-submit",cancelClassName:"btn-cancel"},{default:()=>[n==="authorize_project"&&r(N,{vertical:!0},{default:()=>[r(N,null,{default:()=>[r(d,{size:"small",type:"primary",onClick:this.onRevokeProject},z(o=c("security.user.revoke_auth"))?o:{default:()=>[o]}),r(d,{size:"small",type:"primary",onClick:this.onGrantReadPerm},z(l=c("security.user.grant_read"))?l:{default:()=>[l]}),r(d,{size:"small",type:"primary",onClick:this.onGrantAllPerm},z(i=c("security.user.grant_all"))?i:{default:()=>[i]}),r(J,{size:"small",placeholder:c("project.list.project_tips"),clearable:!0,value:this.searchVal,"onUpdate:value":s=>this.searchVal=s},null),r(d,{size:"small",type:"primary",onClick:()=>this.getProjects(p)},{default:()=>[r(Q,null,{default:()=>[r($,null,null)]})]})]}),r(X,{virtualScroll:!0,"row-class-name":"items",columns:this.columnsRef.columns,data:this.projectWithAuthorizedLevel,loading:this.loading,"max-height":"250","row-key":this.rowKey,"on-update:checked-row-keys":this.handleCheck},null),r("div",{class:g.pagination},[r(Y,{page:this.pagination.page,"onUpdate:page":s=>this.pagination.page=s,"page-size":this.pagination.pageSize,"onUpdate:page-size":s=>this.pagination.pageSize=s,"page-count":this.pagination.totalPage,"show-size-picker":!0,"page-sizes":[5,10],"show-quick-jumper":!0,onUpdatePage:this.requestData,onUpdatePageSize:this.handleChangePageSize},null)])]}),n==="authorize_datasource"&&r(P,{virtualScroll:!0,options:this.unauthorizedDatasources,filterable:!0,value:this.authorizedDatasources,"onUpdate:value":s=>this.authorizedDatasources=s,class:g.transfer},null),n==="authorize_namespace"&&r(P,{virtualScroll:!0,options:this.unauthorizedNamespaces,filterable:!0,value:this.authorizedNamespaces,"onUpdate:value":s=>this.authorizedNamespaces=s,class:g.transfer},null)]})}});export{it as AuthorizeModal,it as default};
